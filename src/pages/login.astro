---
import Layout from '../layouts/Layout.astro';
import ThemeSelector from '../components/ThemeSelector.astro';
import { isAuthenticated } from '../lib/auth';

// If already authenticated, redirect to services
if (isAuthenticated(Astro.cookies)) {
  return Astro.redirect('/services');
}

// Get redirect URL from query params
const redirectUrl = Astro.url.searchParams.get('redirect') || '/services';
---

<Layout title="Login - Mikey's Home Page">
  <ThemeSelector />
  <main class="min-h-screen flex items-center justify-center px-4 sm:px-6 lg:px-8 transition-colors" style="background-color: var(--theme-bg);">
    <div class="w-full max-w-md">
      <!-- Logo/Brand -->
      <div class="text-center mb-8">
        <a href="/" class="inline-block">
          <h1 class="text-4xl font-bold bg-clip-text text-transparent" style="background-image: linear-gradient(to right, var(--theme-primary), var(--theme-primary-hover)); -webkit-background-clip: text;">
            Mikey
          </h1>
        </a>
        <p class="mt-2 text-sm" style="color: var(--theme-text); opacity: 0.7;">
          Sign in to access the dashboard
        </p>
      </div>

      <!-- Login Card -->
      <div class="rounded-2xl p-8 border transition-all duration-300 shadow-xl" style="background-color: var(--theme-card); border-color: var(--theme-border);">
        <!-- Terminal-style header -->
        <div class="flex items-center gap-2 mb-6 pb-4 border-b" style="border-color: var(--theme-border);">
          <div class="w-3 h-3 rounded-full bg-red-500"></div>
          <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
          <div class="w-3 h-3 rounded-full bg-green-500"></div>
          <span class="ml-2 text-sm font-mono" style="color: var(--theme-text); opacity: 0.6;">~/auth/login</span>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden mb-4 p-3 rounded-lg bg-red-500/10 border border-red-500/20 text-red-400 text-sm">
          Invalid username or password
        </div>

        <!-- Login Form -->
        <form id="login-form" class="space-y-6">
          <input type="hidden" name="redirect" value={redirectUrl} />

          <div>
            <label for="username" class="block text-sm font-medium mb-2" style="color: var(--theme-text);">
              Username
            </label>
            <input
              type="text"
              id="username"
              name="username"
              required
              autocomplete="username"
              class="w-full px-4 py-3 rounded-lg border transition-all duration-200 focus:outline-none focus:ring-2"
              style="background-color: var(--theme-bg); border-color: var(--theme-border); color: var(--theme-text);"
              placeholder="Enter your username"
            />
          </div>

          <div>
            <label for="password" class="block text-sm font-medium mb-2" style="color: var(--theme-text);">
              Password
            </label>
            <input
              type="password"
              id="password"
              name="password"
              required
              autocomplete="current-password"
              class="w-full px-4 py-3 rounded-lg border transition-all duration-200 focus:outline-none focus:ring-2"
              style="background-color: var(--theme-bg); border-color: var(--theme-border); color: var(--theme-text);"
              placeholder="Enter your password"
            />
          </div>

          <button
            type="submit"
            id="submit-btn"
            class="w-full py-3 px-4 rounded-lg font-medium text-white transition-all duration-200 hover:scale-[1.02] hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
            style="background-color: var(--theme-primary-bg);"
          >
            <span id="btn-text">Sign In</span>
            <span id="btn-loading" class="hidden">
              <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>
        </form>

        <!-- Back to home -->
        <div class="mt-6 text-center">
          <a href="/" class="text-sm hover:underline transition-colors" style="color: var(--theme-primary);">
            &larr; Back to Home
          </a>
        </div>
      </div>
    </div>
  </main>

  <script>
    const form = document.getElementById('login-form') as HTMLFormElement;
    const errorMessage = document.getElementById('error-message');
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const btnText = document.getElementById('btn-text');
    const btnLoading = document.getElementById('btn-loading');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Show loading state
      submitBtn.disabled = true;
      btnText?.classList.add('hidden');
      btnLoading?.classList.remove('hidden');
      errorMessage?.classList.add('hidden');

      const formData = new FormData(form);
      const username = formData.get('username') as string;
      const password = formData.get('password') as string;
      const redirect = formData.get('redirect') as string;

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password }),
        });

        const data = await response.json();

        if (response.ok && data.success) {
          // Redirect to the requested page or services
          window.location.href = redirect || '/services';
        } else {
          // Show error
          errorMessage?.classList.remove('hidden');
          if (errorMessage) {
            errorMessage.textContent = data.error || 'Invalid username or password';
          }
        }
      } catch (error) {
        errorMessage?.classList.remove('hidden');
        if (errorMessage) {
          errorMessage.textContent = 'An error occurred. Please try again.';
        }
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        btnText?.classList.remove('hidden');
        btnLoading?.classList.add('hidden');
      }
    });
  </script>
</Layout>
